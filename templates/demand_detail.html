<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Demanda - {{ demand.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .navbar-brand img { height: 40px; width: auto; }
        .navbar-brand, .nav-link { color: var(--cor-texto) !important; }
        .nav-link.active { color: var(--cor-principal) !important; font-weight: 600; }
        .btn-primary { background-color: var(--cor-principal); border-color: var(--cor-principal); color: #121212; font-weight: 600; }
        
        .status-text-nao-visto { color: #6c757d !important; font-weight: bold; }
        .status-text-em-andamento { color: #0d6efd !important; font-weight: bold; }
        .status-text-aguardando { color: #fd7e14 !important; font-weight: bold; }
        .status-text-parado { color: #dc3545 !important; font-weight: bold; }
        .status-text-concluido { color: #198574 !important; font-weight: bold; }
        
        .priority-normal { color: var(--cor-texto); }
        .priority-alta { color: #ffc107; }
        .priority-urgente { color: #dc3545; }

        .demand-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 2.5rem; padding: 1.5rem 0; }
        .detail-item .detail-label { font-size: 0.8rem; color: #8a9198; text-transform: uppercase; margin-bottom: 0.35rem; font-weight: 500; }
        .detail-item .detail-value { font-size: 1.1rem; font-weight: 600; margin: 0; }
        .demand-metadata { border-top: 1px solid var(--cor-borda); padding-top: 1rem; }

        .time-tracking-panel { background-color: rgba(0,0,0,0.15); border: 1px solid var(--cor-borda); border-radius: 8px; padding: 1.25rem; }
        .total-duration-summary .total-label { color: #aaa; font-size: 0.9rem; }
        .total-duration-summary .total-value { font-size: 1.2rem; font-weight: bold; color: var(--bs-success); }
        .duration-list li { display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .duration-list li:last-child { border-bottom: none; }

        .actions-panel { background-color: rgba(255, 255, 255, 0.03); border: 1px solid var(--cor-borda); border-radius: 0.5rem; padding: 1.5rem; }
    </style>
</head>
<body>
    {% macro colorize_status(status_text) %}
        {% set status_class = 'status-text-nao-visto' %}
        {% if status_text == 'Em Andamento' %}{% set status_class = 'status-text-em-andamento' %}
        {% elif status_text.startswith('AG.') %}{% set status_class = 'status-text-aguardando' %}
        {% elif status_text == 'PARADO' %}{% set status_class = 'status-text-parado' %}
        {% elif status_text == 'CONCLUIDO' %}{% set status_class = 'status-text-concluido' %}
        {% endif %}
        <span class="{{ status_class }}">{{ status_text }}</span>
    {% endmacro %}

    <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom" data-bs-theme="dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('home_page') }}">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="ALFA-TASK Logo" style="height: 40px;">
        </a>

        <div class="d-flex">
            <a class="btn btn-outline-secondary me-2 {% if request.endpoint == 'home_page' %}active{% endif %}" href="{{ url_for('home_page') }}">Home</a>
            <a class="btn btn-outline-secondary me-2 {% if request.endpoint in ['dashboard', 'demand_detail', 'new_demand', 'edit_demand'] %}active{% endif %}" href="{{ url_for('dashboard') }}">Demandas Ativas</a>
            <a class="btn btn-outline-secondary me-2 {% if request.endpoint == 'completed_demands' %}active{% endif %}" href="{{ url_for('completed_demands') }}">Demandas Concluídas</a>
            <a class="btn btn-outline-secondary {% if request.endpoint in ['commission_tasks', 'commission_task_detail', 'new_commission_task', 'edit_commission_task'] %}active{% endif %}" href="{{ url_for('commission_tasks') }}">Serviços Feitos</a>
        </div>

        <div class="d-flex align-items-center ms-auto">
            <a href="{{ url_for('notes') }}" class="btn btn-outline-secondary me-3 {% if request.endpoint == 'notes' %}active{% endif %}">Anotações</a>
            <span class="navbar-text me-3">Bem-vindo, {{ current_user.username.capitalize() }}!</span>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm d-flex align-items-center" title="Sair"><i class="bi bi-box-arrow-right me-1"></i>Sair</a>
        </div>
    </div>
</nav>
    <main class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">{{ demand.title }} ({{ demand.demand_number }})</h3>
                <div>
                    {% if current_user.role in ['Gerente', 'Supervisor'] %}
                        <a href="{{ url_for('edit_demand', demand_id=demand.id) }}" class="btn btn-secondary btn-sm">Editar</a>
                        <form action="{{ url_for('delete_demand', demand_id=demand.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza?');">
                            <button type="submit" class="btn btn-danger btn-sm">Apagar</button>
                        </form>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <p class="card-text mb-4" style="white-space: pre-wrap;">{{ demand.description }}</p>

                <div class="demand-details-grid">
                    <div class="detail-item">
                        <h6 class="detail-label">Status</h6>
                        <p class="detail-value">{{ demand.status }}</p>
                    </div>
                    <div class="detail-item">
                        <h6 class="detail-label">Atribuído a</h6>
                        <p class="detail-value">{{ demand.assigned_to.username.capitalize() if demand.assigned_to else 'Ninguém' }}</p>
                    </div>
                    <div class="detail-item">
                        <h6 class="detail-label">Prioridade</h6>
                        <p class="detail-value priority-{{ demand.priority.lower() }}">{{ demand.priority }}</p>
                    </div>
                </div>
                <div class="demand-metadata text-muted small mt-2">
                    Criado por <strong>{{ demand.requester.username.capitalize() }}</strong> em {{ demand.created_at | localdatetime('%d/%m/%Y às %H:%M') }}
                </div>
                
                <div class="time-tracking-panel mt-4">
                    <div class="panel-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Acompanhamento de Tempo</h5>
                        {% if total_duration %}
                        <div class="total-duration-summary">
                            <span class="total-label">Tempo Total: </span>
                            <span class="total-value">{{ total_duration }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <hr class="mt-2 mb-3" style="border-color: rgba(255,255,255,0.1);">
                    <ul class="list-unstyled duration-list mb-0">
                    {% for status, time in durations.items() %}
                        <li><span>{{ status }}:</span> <span>{{ time }}</span></li>
                    {% else %}
                        <li>Nenhum tempo registrado.</li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="mb-4 actions-panel">
            <h4 class="mb-4">Painel de Ações</h4>
            <div class="row g-4">
                <div class="col-lg-6">
                    <h6 class="mb-3">Alterar Status da Demanda</h6>
                    <form action="{{ url_for('update_demand_status', demand_id=demand.id) }}" method="POST">
                        <div class="mb-3">
                            <label for="status" class="form-label">Novo Status</label>
                            <select class="form-select" id="status" name="status">
                              <option value="Não Visto" {% if demand.status == 'Não Visto' %}selected{% endif %}>Não visto</option>
                              <option value="Em Andamento" {% if demand.status == 'Em Andamento' %}selected{% endif %}>Em andamento</option>
                              <option value="AG. ADM" {% if demand.status == 'AG. ADM' %}selected{% endif %}>AG. ADM</option>
                              <option value="AG. EVANDRO" {% if demand.status == 'AG. EVANDRO' %}selected{% endif %}>AG. EVANDRO</option>
                              <option value="AG. COMERCIAL" {% if demand.status == 'AG. COMERCIAL' %}selected{% endif %}>AG. COMERCIAL</option>
                              <option value="PARADO" {% if demand.status == 'PARADO' %}selected{% endif %}>Parado</option>
                              <option value="CONCLUIDO" {% if demand.status == 'CONCLUIDO' %}selected{% endif %}>Concluido</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="note" class="form-label">Nota de Atualização (Opcional)</label>
                            <textarea class="form-control" id="note" name="note" rows="3"></textarea>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Atualizar Status</button>
                        </div>
                    </form>
                </div>
                {% if current_user.role in ['Gerente', 'Supervisor'] %}
                <div class="col-lg-6">
                    <h6 class="mb-3">Atribuir Responsável</h6>
                    <form action="{{ url_for('assign_demand', demand_id=demand.id) }}" method="POST">
                        <div class="mb-3">
                            <label for="user_id" class="form-label">Atribuir para</label>
                            <select class="form-select" id="user_id" name="user_id">
                                <option value="">Selecione um usuário...</option>
                                {% for user in users %}
                                    <option value="{{ user.id }}" {% if demand.assigned_to_id == user.id %}selected{% endif %}>
                                        {{ user.username.capitalize() }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary mt-4">Atribuir Usuário</button>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h4>Histórico de Atividades</h4></div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for log in logs %}
                    <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center">
                        <div class="w-100">
                            <p class="mb-1">
                                {% if log.action.startswith("Status alterado de") %}
                                    {% set parts = log.action.split("'") %}
                                    {{ parts[0] }}
                                    '{{ colorize_status(parts[1]) | safe }}'
                                    {{ parts[2] }}
                                    '{{ colorize_status(parts[3]) | safe }}'{% if parts|length > 4 %}{{ parts[4] }}{% endif %}
                                {% else %}
                                    {{ log.action }}
                                {% endif %}
                            </p>
                            <small class="text-muted">Por: <strong>{{ log.user.username.capitalize() }}</strong> em {{ log.timestamp | localdatetime('%d/%m/%Y às %H:%M') }}</small>
                        </div>
                        {% if current_user.role in ['Gerente', 'Supervisor'] %}
                        <form action="{{ url_for('delete_log', log_id=log.id) }}" method="POST" class="d-inline ms-3" onsubmit="return confirm('Tem certeza?');">
                            <button type="submit" class="btn btn-outline-danger btn-sm py-0 px-1">&times;</button>
                        </form>
                        {% endif %}
                    </li>
                    {% else %}
                    <li class="list-group-item bg-transparent">Nenhum histórico para esta demanda.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </main>
</body>
</html>